name: Global Parquet Converter
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: 1. كودلارنى يۈكلەش
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Python تەييارلاش
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 3. قوراللارنى قاچىلاش
        run: pip install pandas pyarrow fastparquet

      - name: 4. ھۆججەت ئىزدەش ۋە ئايلاندۇرۇش (Deep Scan)
        run: |
          python -c "
          import pandas as pd
          import os
          
          found_any = False
          # پۈتۈن ئامبارنى تىنتىپ چىقىدۇ
          for root, dirs, files in os.walk('.'):
              for file in files:
                  # ھۆججەت نامى .jsonl بىلەن ئاخىرلاشقان بولسا (چوڭ-كىچىك ھەرپ پەرقىسىز)
                  if file.lower().endswith('.jsonl'):
                      found_any = True
                      input_path = os.path.join(root, file)
                      output_path = input_path.rsplit('.', 1)[0] + '.parquet'
                      
                      print(f'تېپىلدى: {input_path}')
                      try:
                          df = pd.read_json(input_path, lines=True)
                          df.to_parquet(output_path, engine='pyarrow', index=False)
                          print(f'✅ مۇۋەپپەقىيەتلىك ئايلاندى: {output_path}')
                      except Exception as e:
                          print(f'❌ خاتالىق {input_path}: {e}')
          
          if not found_any:
              print('⚠️ ئاگاھلاندۇرۇش: بىرەر دانىمۇ .jsonl ھۆججىتى تېپىلمىدى!')
          "

      - name: 5. ئۆزگىرىشنى يوللاش
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # بارلىق parquet ھۆججەتلىرىنى بىخەتەر قوشۇش
          FILES=$(find . -name "*.parquet")
          if [ -n "$FILES" ]; then
            git add $FILES
            git commit -m "Auto-convert to Parquet" || echo "ئۆزگىرىش يوق"
            git push
          else
            echo "يوللايدىغان parquet ھۆججىتى يوق."
          fi
