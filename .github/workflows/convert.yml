name: Global Parquet Converter
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pandas pyarrow fastparquet

      - name: Process All Files
        run: |
          python -c "
          import pandas as pd
          import glob
          import os
          
          # بارلىق قىسقۇچلارنى سۈزۈپ چىقىدۇ
          files = glob.glob('**/*.jsonl', recursive=True)
          print(f'تېپىلغان ھۆججەت سانى: {len(files)}')
          
          for f in files:
              # .github مۇندەرىجىسىدىكىلەرنى ئۆتكۈزۈۋېتىدۇ
              if '.github' in f: continue
              try:
                  if os.path.getsize(f) == 0:
                      print(f'بوش ھۆججەت: {f}')
                      continue
                  
                  df = pd.read_json(f, lines=True)
                  output = f.replace('.jsonl', '.parquet')
                  df.to_parquet(output, engine='pyarrow', index=False)
                  print(f'مۇۋەپپەقىيەتلىك ئايلاندى: {output}')
              except Exception as e:
                  print(f'خاتالىق {f}: {e}')
          "

      - name: Push results
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ئاۋۋال parquet ھۆججەتلىرىنىڭ بار-يوقلۇقىنى تەكشۈرىمىز
          if ls **/*.parquet 1> /dev/null 2>&1; then
            git add **/*.parquet
            # ئۆزگىرىش بولغان-بولمىغانلىقىنى تەكشۈرۈپ ئاندىن Commit قىلىمىز
            if git diff --staged --quiet; then
              echo "يېڭى ئۆزگىرىش يوق."
            else
              git commit -m "Auto-convert to Parquet"
              git push
            fi
          else
            echo "ھېچقانداق Parquet ھۆججىتى ھاسىل بولمىدى، شۇڭا يوللانمىدى."
          fi
